# 部署指南

本文档提供了在生产环境中部署 Q&A 问答平台的详细说明。

## 环境要求

- Node.js (v14+)
- MySQL (v5.7+)
- Nginx
- PM2（用于进程管理）
- 域名（可选）
- SSL证书（可选）

## 部署步骤

### 1. 准备服务器

1. 安装必要的软件包：
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y nodejs npm mysql-server nginx

# CentOS/RHEL
sudo yum update
sudo yum install -y nodejs npm mysql-server nginx
```

2. 安装 PM2：
```bash
npm install -y pm2 -g
```

### 2. 配置 MySQL

1. 启动 MySQL 服务：
```bash
sudo systemctl start mysql
sudo systemctl enable mysql
```

2. 设置 root 密码：
```bash
sudo mysql_secure_installation
```

3. 创建数据库和用户：
```sql
CREATE DATABASE qa_platform;
CREATE USER 'qa_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON qa_platform.* TO 'qa_user'@'localhost';
FLUSH PRIVILEGES;
```

### 3. 部署应用

1. 克隆代码：
```bash
git clone <repository-url>
cd Q&A
```

2. 安装依赖：
```bash
npm run install-all
```

3. 配置环境变量：
```bash
cp server/config.env.example server/.env
```

编辑 `.env` 文件：
```env
NODE_ENV=production
DB_HOST=localhost
DB_USER=qa_user
DB_PASSWORD=your_password
DB_NAME=qa_platform
JWT_SECRET=your_secure_jwt_secret
PORT=5000
```

4. 构建前端：
```bash
cd client
npm run build
cd ..
```

5. 配置 PM2：

创建 `ecosystem.config.js`：
```javascript
module.exports = {
  apps: [{
    name: 'qa-platform',
    script: 'server/index.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
```

6. 启动应用：
```bash
pm2 start ecosystem.config.js
```

### 4. 配置 Nginx

1. 创建 Nginx 配置文件：
```bash
sudo nano /etc/nginx/sites-available/qa-platform
```

2. 添加以下配置：
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        root /path/to/Q&A/client/build;
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

3. 启用站点：
```bash
sudo ln -s /etc/nginx/sites-available/qa-platform /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 5. SSL 配置（可选）

1. 安装 Certbot：
```bash
sudo apt install -y certbot python3-certbot-nginx
```

2. 获取 SSL 证书：
```bash
sudo certbot --nginx -d your-domain.com
```

### 6. 安全配置

1. 配置防火墙：
```bash
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

2. 设置文件权限：
```bash
chmod -R 755 /path/to/Q&A
chown -R www-data:www-data /path/to/Q&A
```

## 维护说明

### 1. 日常维护

1. 查看日志：
```bash
pm2 logs qa-platform
```

2. 监控应用状态：
```bash
pm2 monit
```

3. 重启应用：
```bash
pm2 restart qa-platform
```

### 2. 更新部署

1. 拉取最新代码：
```bash
git pull origin main
```

2. 安装依赖：
```bash
npm run install-all
```

3. 构建前端：
```bash
cd client && npm run build
```

4. 重启应用：
```bash
pm2 restart qa-platform
```

### 3. 数据库备份

1. 创建备份：
```bash
mysqldump -u qa_user -p qa_platform > backup.sql
```

2. 恢复备份：
```bash
mysql -u qa_user -p qa_platform < backup.sql
```

## 故障排除

### 1. 应用无法启动
- 检查环境变量配置
- 检查数据库连接
- 查看 PM2 日志

### 2. 无法访问网站
- 检查 Nginx 配置
- 检查防火墙设置
- 验证域名解析

### 3. 数据库连接失败
- 检查数据库服务状态
- 验证数据库用户权限
- 确认连接字符串正确

## 性能优化

### 1. Node.js 优化
- 使用 PM2 集群模式
- 启用压缩
- 配置缓存

### 2. Nginx 优化
- 启用 Gzip 压缩
- 配置缓存
- 优化静态文件服务

### 3. MySQL 优化
- 配置连接池
- 优化查询性能
- 定期维护索引

## 监控和告警

### 1. 应用监控
- 使用 PM2 监控
- 配置错误日志
- 设置性能指标

### 2. 服务器监控
- 监控 CPU 使用率
- 监控内存使用
- 监控磁盘空间

### 3. 告警设置
- 配置错误告警
- 设置性能告警
- 监控安全事件 