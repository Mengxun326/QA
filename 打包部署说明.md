# 📦 Q&A平台打包部署完整指南

## 🎯 概述

本指南详细说明如何将Q&A问答平台打包成生产环境部署包，并在宝塔面板上进行部署。

## 📋 打包前准备

### 1. 环境要求
- **Node.js**: 16.0+ 版本
- **npm**: 8.0+ 版本
- **操作系统**: Windows 10+ 或 Linux/macOS

### 2. 检查项目完整性
确保项目包含以下文件和目录：
```
qa-platform/
├── client/          # 前端React项目
├── server/          # 后端Node.js项目
├── database.sql     # 数据库初始化脚本
├── package.json     # 根项目配置
├── build.sh         # Linux/macOS打包脚本
├── build.bat        # Windows打包脚本
└── 部署相关文件...
```

## 🚀 打包方法

### 方法一：使用npm脚本（推荐）

#### Linux/macOS环境：
```bash
npm run package
# 或者
npm run build-production
```

#### Windows环境：
```bash
npm run package-win
# 或者
npm run build-windows
```

### 方法二：直接运行脚本

#### Linux/macOS环境：
```bash
chmod +x build.sh
./build.sh
```

#### Windows环境：
```cmd
build.bat
```

### 方法三：手动打包

如果自动脚本无法运行，可以按以下步骤手动打包：

#### 1. 安装后端依赖
```bash
cd server
npm install --production
cd ..
```

#### 2. 构建前端
```bash
cd client
npm install
npm run build
cd ..
```

#### 3. 创建打包目录
```bash
mkdir build
mkdir build/server
mkdir build/client
```

#### 4. 复制文件
```bash
# 复制后端文件
cp -r server/*.js build/server/
cp -r server/package*.json build/server/
cp -r server/routes build/server/
cp -r server/middleware build/server/
cp -r server/config build/server/
cp -r server/node_modules build/server/
cp server/config.env.example build/server/

# 复制前端构建文件
cp -r client/build build/client/
cp client/package.json build/client/

# 复制配置和文档
cp database.sql build/
cp ecosystem.config.js build/
cp nginx.conf.template build/
cp *.md build/
```

## 📦 打包结果

打包完成后，会在 `dist/` 目录下生成以下文件：

```
dist/
├── qa-platform-YYYYMMDD_HHMMSS.tar.gz  # Linux压缩包
└── qa-platform-YYYYMMDD_HHMMSS.zip     # Windows压缩包
```

## 📁 部署包结构

解压后的部署包包含以下内容：

```
qa-platform/
├── server/                    # 后端服务
│   ├── index.js              # 服务器入口文件
│   ├── package.json          # 后端依赖配置
│   ├── config.env.example    # 环境变量模板
│   ├── routes/               # API路由
│   ├── middleware/           # 中间件
│   ├── config/               # 配置文件
│   └── node_modules/         # 后端依赖包
├── client/                   # 前端构建文件
│   └── build/                # React构建产物
├── database.sql              # 数据库初始化脚本
├── ecosystem.config.js       # PM2配置文件
├── nginx.conf.template       # Nginx配置模板
├── install.sh                # 自动安装脚本
├── VERSION.txt               # 版本信息
├── README.md                 # 部署说明
├── 宝塔部署指南.md           # 详细部署指南
└── 宝塔部署快速指南.md       # 快速部署指南
```

## 🚀 部署流程

### 1. 上传部署包

将生成的压缩包上传到服务器：

```bash
# 方式一：使用scp
scp qa-platform-*.tar.gz root@your-server:/tmp/

# 方式二：使用宝塔面板文件管理器直接上传
```

### 2. 解压部署包

```bash
cd /www/wwwroot
tar -xzf /tmp/qa-platform-*.tar.gz
mv qa-platform-* qa-platform
```

### 3. 运行安装脚本

```bash
cd /www/wwwroot/qa-platform
chmod +x install.sh
./install.sh
```

### 4. 配置数据库

1. 在宝塔面板中创建数据库：
   - 数据库名：`qa_platform`
   - 用户名：`qa_user`（建议）
   - 密码：设置强密码

2. 导入数据库结构：
   ```bash
   mysql -u qa_user -p qa_platform < database.sql
   ```

### 5. 配置环境变量

编辑 `/www/wwwroot/qa-platform/server/config.env`：

```env
# 数据库配置
DB_HOST=localhost
DB_USER=qa_user
DB_PASSWORD=your_database_password
DB_NAME=qa_platform

# JWT密钥（请设置复杂密钥）
JWT_SECRET=your_super_secret_jwt_key_here

# 服务器端口
PORT=5000

# 管理员默认账号
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123
```

### 6. 配置Nginx

在宝塔面板中：
1. 添加网站，根目录设为：`/www/wwwroot/qa-platform/client/build`
2. 配置反向代理，参考 `nginx.conf.template`

### 7. 创建管理员账户

```bash
cd /www/wwwroot/qa-platform/server
npm run create-admin
```

### 8. 启动服务

```bash
cd /www/wwwroot/qa-platform
pm2 start ecosystem.config.js --env production
pm2 save
pm2 startup
```

## 🔧 验证部署

### 1. 检查服务状态
```bash
pm2 status
pm2 logs qa-platform-server
```

### 2. 测试网站访问
- 访问你的域名
- 测试管理员登录功能
- 测试提问和回答功能

## 📊 监控和维护

### 常用命令
```bash
# 查看应用状态
pm2 status

# 查看应用日志
pm2 logs qa-platform-server

# 重启应用
pm2 restart qa-platform-server

# 停止应用
pm2 stop qa-platform-server

# 查看实时监控
pm2 monit
```

### 更新部署
```bash
# 1. 备份数据库
mysqldump -u qa_user -p qa_platform > backup.sql

# 2. 停止服务
pm2 stop qa-platform-server

# 3. 解压新版本
cd /www/wwwroot
tar -xzf qa-platform-new.tar.gz
cp -r qa-platform-new/* qa-platform/

# 4. 重启服务
cd qa-platform
pm2 restart qa-platform-server
```

## 🐛 常见问题

### 1. 打包失败
- **Node.js版本过低**：升级到16+版本
- **依赖安装失败**：检查网络连接，尝试使用淘宝镜像
- **权限问题**：确保有写入权限

### 2. 部署失败
- **端口被占用**：检查5000端口是否被占用
- **数据库连接失败**：检查配置文件和数据库权限
- **Nginx配置错误**：检查反向代理配置

### 3. 运行时问题
- **前端无法加载**：检查Nginx配置和文件权限
- **API请求失败**：检查反向代理和后端服务状态
- **管理员无法登录**：检查数据库和JWT配置

## 💡 优化建议

### 1. 性能优化
- 启用Nginx Gzip压缩
- 配置静态资源缓存
- 使用CDN加速

### 2. 安全优化
- 配置SSL证书
- 设置防火墙规则
- 定期更新依赖包

### 3. 监控优化
- 配置日志轮转
- 设置监控告警
- 定期备份数据

## 📞 技术支持

如遇到问题，请按以下顺序排查：

1. 查看错误日志：`pm2 logs qa-platform-server`
2. 检查Nginx错误日志：`/var/log/nginx/error.log`
3. 验证配置文件：检查 `config.env` 和数据库连接
4. 查看系统资源：`top`, `df -h`, `free -m`

---

**祝您部署成功！** 🎉 