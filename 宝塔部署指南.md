# Q&A问答平台 - 宝塔面板部署指南

## 📋 部署前准备

### 1. 服务器要求
- **操作系统**: CentOS 7+ / Ubuntu 18+ / Debian 9+
- **内存**: 至少 1GB RAM
- **硬盘**: 至少 10GB 可用空间
- **网络**: 确保服务器可以访问外网

### 2. 宝塔面板要求
- **宝塔Linux面板**: 7.0+ 版本
- **必需软件**: Nginx, MySQL 5.7+, PM2管理器
- **Node.js**: 16+ 版本

## 🚀 部署步骤

### 第一步：安装宝塔面板（如果还没安装）

```bash
# CentOS/RHEL
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh

# Ubuntu/Debian
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

### 第二步：安装必需软件

1. **登录宝塔面板**
   - 访问 `http://你的服务器IP:8888`
   - 使用安装时显示的用户名和密码登录

2. **安装软件栈**
   - 进入"软件商店"
   - 安装以下软件：
     - **Nginx** (推荐最新版本)
     - **MySQL** (5.7 或 8.0)
     - **PM2管理器** (Node.js应用管理)
     - **Node.js版本管理器** (安装Node.js 16+)

### 第三步：上传项目文件

1. **创建网站目录**
   ```bash
   mkdir -p /www/wwwroot/qa-platform
   ```

2. **上传项目文件**
   - 方式一：使用宝塔面板文件管理器上传
   - 方式二：使用Git克隆（推荐）
   ```bash
   cd /www/wwwroot
   git clone [你的项目仓库地址] qa-platform
   ```

3. **设置目录权限**
   ```bash
   chown -R www:www /www/wwwroot/qa-platform
   chmod -R 755 /www/wwwroot/qa-platform
   ```

### 第四步：配置数据库

1. **创建数据库**
   - 进入宝塔面板 → 数据库 → 添加数据库
   - 数据库名：`qa_platform`
   - 用户名：`qa_user`（建议）
   - 密码：设置一个强密码

2. **导入数据库结构**
   - 在数据库管理中，点击"导入"
   - 上传项目中的 `database.sql` 文件
   - 或者使用phpMyAdmin导入

### 第五步：配置后端服务

1. **进入服务器目录**
   ```bash
   cd /www/wwwroot/qa-platform/server
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **配置环境变量**
   ```bash
   cp config.env.example config.env
   ```
   
   编辑 `config.env` 文件：
   ```env
   # 数据库配置
   DB_HOST=localhost
   DB_USER=qa_user
   DB_PASSWORD=你的数据库密码
   DB_NAME=qa_platform
   
   # JWT密钥（请设置一个复杂的密钥）
   JWT_SECRET=your_super_secret_jwt_key_here_make_it_long_and_complex
   
   # 服务器端口
   PORT=5000
   
   # 管理员默认账号
   ADMIN_USERNAME=admin
   ADMIN_PASSWORD=admin123
   ```

4. **创建管理员账户**
   ```bash
   npm run create-admin
   ```

### 第六步：配置前端

1. **进入前端目录**
   ```bash
   cd /www/wwwroot/qa-platform/client
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **修改API地址**
   编辑 `src/services/api.js`，将API基础URL改为你的服务器地址：
   ```javascript
   const API_BASE_URL = 'http://你的域名或IP:5000/api';
   // 或者如果使用反向代理：
   const API_BASE_URL = '/api';
   ```

4. **构建生产版本**
   ```bash
   npm run build
   ```

### 第七步：配置PM2管理Node.js应用

1. **安装PM2（如果还没安装）**
   ```bash
   npm install -g pm2
   ```

2. **创建PM2配置文件**
   在项目根目录创建 `ecosystem.config.js`：
   ```javascript
   module.exports = {
     apps: [{
       name: 'qa-platform-server',
       script: './server/index.js',
       cwd: '/www/wwwroot/qa-platform',
       instances: 1,
       autorestart: true,
       watch: false,
       max_memory_restart: '1G',
       env: {
         NODE_ENV: 'production',
         PORT: 5000
       }
     }]
   };
   ```

3. **启动应用**
   ```bash
   cd /www/wwwroot/qa-platform
   pm2 start ecosystem.config.js
   pm2 save
   pm2 startup
   ```

### 第八步：配置Nginx

1. **在宝塔面板中添加网站**
   - 网站 → 添加站点
   - 域名：你的域名（如：qa.example.com）
   - 根目录：`/www/wwwroot/qa-platform/client/build`

2. **配置Nginx反向代理**
   点击网站设置 → 配置文件，添加以下配置：
   ```nginx
   server {
       listen 80;
       server_name 你的域名;
       root /www/wwwroot/qa-platform/client/build;
       index index.html;
       
       # 前端静态文件
       location / {
           try_files $uri $uri/ /index.html;
       }
       
       # API反向代理
       location /api {
           proxy_pass http://127.0.0.1:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
       
       # 静态资源缓存
       location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
           expires 1y;
           add_header Cache-Control "public, immutable";
       }
   }
   ```

### 第九步：配置SSL证书（推荐）

1. **申请SSL证书**
   - 在宝塔面板中：网站 → SSL → Let's Encrypt
   - 或上传自己的SSL证书

2. **强制HTTPS**
   - 开启"强制HTTPS"选项

### 第十步：设置防火墙和安全

1. **配置防火墙**
   - 安全 → 防火墙
   - 开放端口：80, 443, 8888（宝塔面板）
   - 关闭不必要的端口

2. **配置安全设置**
   - 修改宝塔面板默认端口
   - 设置复杂的面板密码
   - 开启面板SSL

## 🔧 部署后配置

### 1. 测试应用
- 访问你的域名，确保前端正常加载
- 测试登录功能（使用创建的管理员账户）
- 测试提问和回答功能

### 2. 监控和维护
```bash
# 查看PM2应用状态
pm2 status

# 查看应用日志
pm2 logs qa-platform-server

# 重启应用
pm2 restart qa-platform-server

# 查看应用监控
pm2 monit
```

### 3. 数据库备份
- 在宝塔面板中设置定时备份
- 建议每天自动备份数据库

## 🐛 常见问题解决

### 1. Node.js版本问题
```bash
# 使用nvm管理Node.js版本
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 16
nvm use 16
```

### 2. 权限问题
```bash
# 修复权限
chown -R www:www /www/wwwroot/qa-platform
chmod -R 755 /www/wwwroot/qa-platform
```

### 3. 端口被占用
```bash
# 查看端口占用
netstat -tulpn | grep :5000
# 或
lsof -i :5000
```

### 4. PM2应用无法启动
```bash
# 查看详细错误日志
pm2 logs qa-platform-server --lines 100
```

## 📱 移动端适配

项目已经包含响应式设计，自动适配移动设备。

## 🔄 更新部署

当需要更新代码时：
```bash
cd /www/wwwroot/qa-platform
git pull origin main
cd client && npm run build
pm2 restart qa-platform-server
```

## 📞 技术支持

如果在部署过程中遇到问题，请检查：
1. 服务器日志：`/www/wwwroot/qa-platform/server/logs/`
2. Nginx错误日志：`/www/wwwroot/qa-platform/logs/`
3. PM2应用日志：`pm2 logs`

---

**祝您部署成功！** 🎉 